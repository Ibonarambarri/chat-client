<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Content Security Policy: protege contra XSS y code injection -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline';
    connect-src 'self' http://localhost:* http://127.0.0.1:* ws://localhost:* ws://127.0.0.1:*;
    img-src 'self' data:;
    font-src 'self';
  ">

  <title>Chat LM Studio</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
  <!-- Main split layout container -->
  <div class="main-container">
    <!-- Top panel: Tasks and Sessions -->
    <div class="tasks-panel" id="tasksPanel">
      <div class="tasks-header">
        <h2>Tareas y Sesiones</h2>
        <div class="tasks-controls">
          <button class="btn-icon" id="newTaskBtn" title="Nueva tarea">
            <i data-lucide="plus"></i>
          </button>
          <button class="btn-icon" id="newSessionBtn" title="Nueva sesión">
            <i data-lucide="play"></i>
          </button>
        </div>
      </div>

      <!-- Active session display -->
      <div class="active-session hidden" id="activeSession">
        <div class="session-info">
          <div class="session-name" id="sessionName">Sesión de trabajo</div>
          <div class="session-timer" id="sessionTimer">00:00</div>
        </div>
        <div class="session-controls">
          <button class="btn-icon" id="sessionPlayPause">
            <i data-lucide="pause"></i>
          </button>
          <button class="btn-icon" id="sessionStop">
            <i data-lucide="stop-circle"></i>
          </button>
        </div>
      </div>

      <!-- Tasks filters -->
      <div class="tasks-filters">
        <button class="filter-btn active" data-filter="all">Todas</button>
        <button class="filter-btn" data-filter="pendiente">Pendientes</button>
        <button class="filter-btn" data-filter="en_progreso">En progreso</button>
        <button class="filter-btn" data-filter="completada">Completadas</button>
      </div>

      <!-- Tasks list -->
      <div class="tasks-list" id="tasksList">
        <!-- Tasks will be rendered here -->
      </div>
    </div>

    <!-- Resizable divider -->
    <div class="resize-handle" id="resizeHandle">
      <div class="resize-handle-bar"></div>
    </div>

    <!-- Bottom panel: Chat -->
    <div class="chat-panel" id="chatPanel">
      <div class="results-window hidden" id="resultsWindow">
        <div class="messages" id="messagesContainer">
          <!-- Los mensajes de calling tool y thinking se crearán dinámicamente aquí -->
        </div>
      </div>

      <!-- Suggestions overlay -->
      <div class="suggestions-window hidden" id="suggestionsWindow">
        <div class="suggestions-list" id="suggestionsList"></div>
      </div>

      <!-- Input integrado dentro del chat -->
      <div class="input-window" id="inputWindow">
        <div class="input-wrapper">
          <div class="thinking-indicator" id="thinkingIndicator">
            <i data-lucide="brain"></i>
          </div>
          <input type="text" id="messageInput" placeholder="Escribe un comando..." autocomplete="off" spellcheck="false" />
        </div>
      </div>
    </div>
  </div>

  <div class="settings-window hidden" id="settingsWindow">
    <div class="settings-content">
      <button class="close-settings" id="closeSettings">
        <i data-lucide="x"></i>
      </button>
      <div class="settings-section">
        <h3>Configuración</h3>
        <div class="settings-list">
          <div class="setting-item horizontal">
            <div class="status-dot" id="statusDot"></div>
            <label>LM STUDIO URL</label>
            <input type="text" id="apiUrl" placeholder="http://localhost:1234" />
          </div>
          <div class="setting-item hidden">
            <label>Temperatura</label>
            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" />
            <span id="tempValue">0.7</span>
          </div>
          <div class="setting-item">
            <div class="switch-container">
              <input type="checkbox" id="noThink" checked />
              <label for="noThink" class="switch-label">
                <span class="switch-slider">
                  <span class="switch-text-left">
                    <i data-lucide="brain"></i>
                    <span>/think</span>
                  </span>
                  <span class="switch-text-right">
                    <i data-lucide="brain-off"></i>
                    <span>/no_think</span>
                  </span>
                </span>
              </label>
            </div>
          </div>
          <div class="setting-item">
            <div class="switch-container">
              <input type="checkbox" id="debugMode" />
              <label for="debugMode" class="switch-label">
                <span class="switch-slider">
                  <span class="switch-text-left">
                    <i data-lucide="bug-off"></i>
                    <span>Normal</span>
                  </span>
                  <span class="switch-text-right">
                    <i data-lucide="bug"></i>
                    <span>Debug</span>
                  </span>
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="help-window hidden" id="helpWindow">
    <div class="help-content">
      <button class="close-help" id="closeHelp">
        <i data-lucide="x"></i>
      </button>
      <div class="help-section">
        <h3>Comandos disponibles</h3>
        <div class="command-list">
          <div class="command-item">
            <i data-lucide="circle-help"></i>
            <div class="command-details">
              <span class="command-name">/help</span>
              <span class="command-desc">Mostrar esta ayuda</span>
            </div>
          </div>
          <div class="command-item">
            <i data-lucide="settings"></i>
            <div class="command-details">
              <span class="command-name">/settings</span>
              <span class="command-desc">Abrir configuración</span>
            </div>
          </div>
          <div class="command-item">
            <i data-lucide="eraser"></i>
            <div class="command-details">
              <span class="command-name">/clear</span>
              <span class="command-desc">Limpiar historial</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="queue-container" id="queueContainer"></div>

  <!-- Task modal -->
  <div class="modal hidden" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="taskModalTitle">Nueva tarea</h3>
        <button class="close-modal" id="closeTaskModal">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="taskId" />

        <div class="form-group">
          <label>Título</label>
          <input type="text" id="taskTitle" placeholder="Nombre de la tarea" />
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea id="taskDescription" rows="3" placeholder="Descripción opcional"></textarea>
        </div>

        <div class="form-group">
          <label>Prioridad</label>
          <div class="priority-selector">
            <button class="priority-btn" data-priority="baja">
              <i data-lucide="chevron-down"></i>
              Baja
            </button>
            <button class="priority-btn active" data-priority="media">
              <i data-lucide="minus"></i>
              Media
            </button>
            <button class="priority-btn" data-priority="alta">
              <i data-lucide="chevron-up"></i>
              Alta
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>Categoría</label>
          <select id="taskCategory">
            <option value="Trabajo">Trabajo</option>
            <option value="Personal">Personal</option>
            <option value="Estudio">Estudio</option>
            <option value="Otros">Otros</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha límite (opcional)</label>
          <input type="datetime-local" id="taskDeadline" />
        </div>

        <div class="form-group">
          <label>Tags (separados por comas)</label>
          <input type="text" id="taskTags" placeholder="ej: urgente, importante" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelTaskModal">Cancelar</button>
        <button class="btn-primary" id="saveTask">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Session modal -->
  <div class="modal hidden" id="sessionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Nueva sesión</h3>
        <button class="close-modal" id="closeSessionModal">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nombre de la sesión</label>
          <input type="text" id="sessionNameInput" placeholder="ej: Sesión de estudio" />
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea id="sessionDescription" rows="2" placeholder="Descripción opcional"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="sessionPomodoro" />
            <span>Activar Pomodoro</span>
          </label>
        </div>

        <div class="form-group pomodoro-settings hidden" id="pomodoroSettings">
          <label>Duración trabajo (minutos)</label>
          <input type="number" id="pomodoroWork" value="25" min="1" max="120" />

          <label>Duración descanso (minutos)</label>
          <input type="number" id="pomodoroBreak" value="5" min="1" max="30" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelSessionModal">Cancelar</button>
        <button class="btn-primary" id="saveSession">Iniciar sesión</button>
      </div>
    </div>
  </div>

  <script src="resize.js"></script>
  <script src="tasks-local.js"></script>
  <script src="renderer.js"></script>
</body>

</html>